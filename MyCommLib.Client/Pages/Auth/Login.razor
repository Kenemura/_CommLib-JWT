@page "/auth/login"
@inject IMyAuthenticationService AuthService
@inject IHttpClientFactory HttpFactory

<br/>
<div class="alert alert-info mt-5">Login</div>

<EditForm class="xform-signin" OnValidSubmit="OnSubmit" Model="Req">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <ul>
        @foreach (string msg in ErrorMessages)
        {
            <li style="color: red">@msg</li>
        }
    </ul>

    <div class="form-group">
        <label class="MyFormLabel">Username:</label>
        <InputText class="form-control" @bind-Value="Req.Username" autofocus placeholder="Username" />
    </div>

    <div class="form-group">
        <label class="MyFormLabel">Password:</label>
        <InputText type="password" class="form-control" @bind-Value="Req.Password" placeholder="Password" />
    </div>
    <div class="alert alert-danger my-3">
        <div class="form-check">
            <label class="form-check-label">
                <InputCheckbox class="form-check-input" @bind-Value="@Req.RememberMe" />
                Remember Me:
            </label>
        </div>
        <div>
            Do not tick <b>Remember Me</b> if you are on a public device.
            <br />And, make sure to Logout when you finish.
        </div>
    </div>
    <div class="my-2">
        <button class="btn btn-primary btn-sm" type="submit">Log In</button>
        <a class="btn btn-sm btn-warning" href="@ReturnTo">Cancel</a>
    </div>

</EditForm>

@code {
    [Parameter] public string ReturnTo { get; set; } = "Index";
    LoginModel Req { get; set; } = new LoginModel();
    List<string> ErrorMessages { get; set; } = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        await Task.CompletedTask;
    }

    async Task OnSubmit()
    {
        ErrorMessages = new List<string>();
        try
        {
            var resp = await AuthService.LoginUserAsync(Req);
            if (string.IsNullOrEmpty(resp.AccessToken))
            {
                ErrorMessages.Add("Invalid Username or Password!");
                return;
            }
            await BLS.SetItemAsync("access_token", resp.AccessToken);
            if (Req.RememberMe)
            {
                // var http = HttpFactory.CreateClient("Api");
                var rm = new clsRememberMeW(BLS);
                await rm.Set(Req.Username, resp.RmPassword ?? "");
            }

            NM.NavigateTo(ReturnTo);
        }
        catch (Exception ex) // return BadRequest when not authenticated
        {
            ErrorMessages.Add($"Something went wrong! ({ex.Message})");
            Console.WriteLine(ex.Message);
        }
    }
}
