@page "/MyAccount/Login"

@using System.ComponentModel.DataAnnotations;
@using Microsoft.AspNetCore.Authentication;
@using Microsoft.AspNetCore.Identity;
@using MyCommLib.Server.Data;

@inject SignInManager<IdentityUser> SignInManager
@inject ILogger<MyLogin> Logger
@inject NavigationManager NavigationManager
@* @inject IdentityRedirectManager RedirectManager *@

<PageTitle>Log in</PageTitle>
<MyPageHeader>Login</MyPageHeader>

<EditForm class="" OnValidSubmit="LoginUser" Model="Input" FormName="login">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <ul>
        @foreach (string msg in ErrorMessages) {
            <li style="color: red">@msg</li>
        }
    </ul>

    <div class="form-group">
        <label class="MyFormLabel">Username:</label>
        <InputText class="form-control" @bind-Value="Input.Username" autofocus placeholder="Username" />
    </div>

    <div class="form-group">
        <label class="MyFormLabel">Password:</label>
        <InputText type="password" class="form-control" @bind-Value="Input.Password" placeholder="Password" />
    </div>
    <div class="alert alert-danger my-3">
        <div class="form-check">
            <label class="form-check-label">
                <InputCheckbox class="form-check-input" @bind-Value="@Input.RememberMe" />
                Remember Me:
            </label>
        </div>
        <div>
            Do not tick <b>Remember Me</b> if you are on a public device.
            <br />And, make sure to Logout when you finish.
        </div>
    </div>
    <div class="my-2">
        <button class="btn btn-primary btn-sm" type="submit">Log In</button>
        <a class="btn btn-sm btn-warning" href="@ReturnTo">Cancel</a>
    </div>
</EditForm>

@code {
    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;
    [SupplyParameterFromQuery] public string? ReturnTo { get; set; }
    [SupplyParameterFromForm] private InputModel Input { get; set; } = new();
    List<string> ErrorMessages { get; set; } = new List<string>();

    protected override async Task OnInitializedAsync() {
        if (HttpMethods.IsGet(HttpContext.Request.Method)) {
            // Clear the existing external cookie to ensure a clean login process
            await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);
        }
        ReturnTo ??= MyAppInfo.HomePath;
    }

    public async Task LoginUser() {
        // This doesn't count login failures towards account lockout
        // To enable password failures to trigger account lockout, set lockoutOnFailure: true
        var result = await SignInManager.PasswordSignInAsync(Input.Username, Input.Password, Input.RememberMe, lockoutOnFailure: false);
        if (result.Succeeded) {
            Logger.LogInformation("User logged in.");
            NM.NavigateTo(MyAppInfo.HomePath);
        } else {
            ErrorMessages.Add($"Error: Invalid login attempt.");
        }
    }

    private sealed class InputModel {
        [Required]
        public string Username { get; set; } = "";

        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Display(Name = "Remember me?")]
        public bool RememberMe { get; set; }
    }
}
